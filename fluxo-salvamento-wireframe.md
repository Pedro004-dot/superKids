# ๐ WIREFRAME: Fluxo de Salvamento Super-Kids

## ๐ FLUXO ATUAL (Com Problemas)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ๐ฎ USUรRIO CLICA "GERAR"                     โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                 โก FASE 1: GERAR CAPA                           โ
โ  โข generateImage() โ base64 (1-2MB)                            โ
โ  โข savedCoverFace = coverFaceForState                          โ
โ  โข coverRef.current = coverFaceForState                        โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              ๐ FASE 2: GERAR HISTรRIA COMPLETA                โ
โ  โข generateCompleteStory() โ JSON com 10 pรกginas               โ
โ  โข convertCompleteStoryToBeats() โ Array<Beat>                 โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ               ๐ผ๏ธ FASE 3: GERAR IMAGENS (10x)                   โ
โ  โข Loop: for each page (1-10)                                  โ
โ    - generateImageWithStyleContext() โ base64 (1-2MB cada)     โ
โ    - historyRef.current.push(finishedFace)                     โ
โ    - setComicFaces() โ Atualiza UI                             โ
โ  โข Total: ~10-20MB em base64                                   โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                ๐ฏ FASE 4: GERAR CONTRACAPA                     โ
โ  โข generateImage() โ base64 (1-2MB)                            โ
โ  โข backCoverFaceForState                                       โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              ๐ FASE 5: GERAR E UPLOAD PDF                     โ
โ  โข Coletar faces: [capa, ...histรณria, contracapa]             โ
โ  โข generateAndUploadPDFWithFaces()                             โ
โ    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ    โ ๐ SUBPROCESSO PDF:                                     โ โ
โ    โ 1. Redimensionar cada imagem (1200px, 85% quality)     โ โ
โ    โ 2. Criar PDF com compressรฃo                            โ โ
โ    โ 3. doc.addImage() ร 12 pรกginas                         โ โ
โ    โ 4. doc.output('blob') โ ~3-4MB                         โ โ
โ    โ 5. supabase.storage.upload() โ TIMEOUT 90s โ          โ โ
โ    โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โข โ FALHA: Timeout ou erro de rede                           โ
โ  โข โ๏ธ pdfUrl = null                                            โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                ๐พ FASE 6: SALVAR NO BANCO                      โ
โ  โข comicData = { ..., pdfUrl: null, comicFaces: [...] }        โ
โ  โข Payload: ~10-20MB (faces com base64) ๐ฅ                     โ
โ  โข supabase.from('comics').insert() โ PODE FALHAR              โ
โ    - Timeout por payload muito grande                          โ
โ    - Limite de tamanho do JSONB                                โ
โ    - Problemas de rede                                         โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    โ RESULTADO: ERRO                           โ
โ  โข PDF nรฃo foi salvo no storage                                โ
โ  โข Gibi nรฃo foi salvo no banco (payload muito grande)         โ
โ  โข Usuรกrio vรช: "Erro ao gerar PDF"                             โ
โ  โข Gibi perdido! ๐ข                                            โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐จ PROBLEMAS IDENTIFICADOS:

### 1. **PDF Upload Timeout**
- Arquivo de 3-4MB ainda รฉ grande para conexรตes lentas
- 90s pode nรฃo ser suficiente
- Supabase Storage pode ter limites

### 2. **Fallback com Payload Gigante**
- Se PDF falha, inclui `comicFaces` com base64
- 12 imagens ร 1-2MB = 10-20MB de payload
- JSONB do PostgreSQL tem limites
- Timeout no insert do banco

### 3. **Sem Alternativa Real**
- Se ambos falham, gibi รฉ perdido
- Nรฃo hรก cache local
- Usuรกrio perde todo o trabalho

---

## โ FLUXO PROPOSTO (Soluรงรฃo)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    ๐ฎ USUรRIO CLICA "GERAR"                     โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ            โก FASES 1-4: GERAR IMAGENS (IGUAL)                 โ
โ  โข Capa, Histรณria, Contracapa geradas normalmente              โ
โ  โข Todas as faces salvas em refs/variรกveis locais              โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              ๐พ FASE 5: SALVAR BรSICO PRIMEIRO                 โ
โ  โข comicData = { heroName, genre, createdAt }                  โ
โ  โข Payload: ~1KB (SEM imagens, SEM PDF)                        โ
โ  โข supabase.insert() โ โ SEMPRE FUNCIONA                      โ
โ  โข comic_id retornado                                          โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           ๐ค FASE 6: UPLOAD IMAGENS INDIVIDUAIS                โ
โ  โข Para cada face:                                             โ
โ    - Redimensionar (800px, 80% quality)                       โ
โ    - Upload para storage: user_id/comics/comic_id/page_X.jpg   โ
โ    - Obter URL pรบblica                                         โ
โ    - Atualizar banco: UPDATE comics SET page_X_url = url      โ
โ  โข Se falhar: face fica como base64 (fallback)                 โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              ๐ FASE 7: GERAR PDF (OPCIONAL)                   โ
โ  โข Usar URLs das imagens (nรฃo base64)                          โ
โ  โข PDF menor e mais rรกpido                                     โ
โ  โข Se funcionar: UPDATE comics SET pdf_url = url               โ
โ  โข Se falhar: Gibi jรก estรก salvo, PDF รฉ bonus                  โ
โโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                  โ
                  โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    โ RESULTADO: SUCESSO                        โ
โ  โข Gibi SEMPRE รฉ salvo (dados bรกsicos)                         โ
โ  โข Imagens salvas individualmente (mais confiรกvel)             โ
โ  โข PDF รฉ bonus (se funcionar)                                  โ
โ  โข Usuรกrio nunca perde o trabalho! ๐                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ NOVA ESTRUTURA DO BANCO:

```sql
-- Tabela comics (dados bรกsicos sempre salvos)
CREATE TABLE comics (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id),
  hero_name TEXT NOT NULL,
  genre TEXT NOT NULL,
  story_tone TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  
  -- URLs das imagens individuais
  cover_url TEXT,
  page_1_url TEXT,
  page_2_url TEXT,
  -- ... atรฉ page_10_url
  back_cover_url TEXT,
  
  -- PDF (opcional)
  pdf_url TEXT,
  
  -- Dados bรกsicos (pequenos)
  comic_data JSONB -- Sรณ metadados, sem imagens
);
```

## ๐ง IMPLEMENTAรรO SUGERIDA:

1. **Salvar bรกsico primeiro** - Garantir que gibi nunca รฉ perdido
2. **Upload individual** - Imagens uma por vez, mais confiรกvel
3. **PDF como bonus** - Se funcionar, รณtimo. Se nรฃo, gibi jรก estรก salvo
4. **Fallback em cada etapa** - Sempre ter plano B
5. **Feedback progressivo** - Usuรกrio vรช cada etapa funcionando
